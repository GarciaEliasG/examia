<header class="topbar">
  <div class="brand">
    <img src="assets/images/logo.png" alt="Logo Examia" class="logo">
  </div>
  <button class="icon-btn profile" aria-label="Perfil">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14Z"/>
    </svg>
  </button>
</header>

<main class="wrap">
  <!-- Estado de carga -->
  <div *ngIf="isLoading" class="empty">
    <p>üîÑ Cargando evaluaci√≥n...</p>
  </div>

  <!-- Estado de error -->
  <div *ngIf="error && !isLoading" class="empty">
    <p>‚ùå {{ error }}</p>
    <button class="btn primary" (click)="cargarEvaluacion()">Reintentar</button>
  </div>

  <!-- Contenido principal cuando hay datos -->
  <div *ngIf="!isLoading && !error && examenData">
    <div class="header-row">
      <a routerLink="/alumno/evaluaciones" class="icon-btn back" aria-label="Volver">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M14 7l-5 5 5 5V7z"/></svg>
      </a>
      <h1 class="title">{{ examenData.titulo }}</h1>
    </div>
    
    <p class="subtitle">
      Docente: {{ examenData.docente }} ‚Ä¢ 
      Materia: {{ examenData.materia }} ‚Ä¢ 
      Tiempo restante: {{ formatTime(timeLeft) }}
    </p>

    <form class="questions-form" (ngSubmit)="submitEvaluation()">
      <section *ngFor="let question of questions; let i = index" class="question-card">
        <div class="question-header">
          <p class="q-title">Pregunta {{ i + 1 }} <span class="question-type">({{ getTipoDisplay(question.type) }})</span></p>
          <span class="puntaje">Puntaje: {{ question.puntaje }}</span>
        </div>
        
        <p class="q-text">{{ question.enunciado }}</p>

        <!-- Multiple Choice -->
        <div *ngIf="question.type === 'multiple_choice'" class="q-options multiple-choice">
          <label *ngFor="let option of question.opciones; let j = index" class="option">
            <input 
              type="radio" 
              [name]="'q' + question.id" 
              [value]="option"
              [(ngModel)]="question.respuesta"
              [disabled]="question.saved">
            <span class="option-text">{{ option }}</span>
          </label>
        </div>

        <!-- Texto Corto -->
        <div *ngIf="question.type === 'texto'" class="q-options text-answer">
          <label [for]="'q' + question.id">Tu respuesta:</label>
          <input 
            type="text" 
            [id]="'q' + question.id" 
            [name]="'q' + question.id" 
            [(ngModel)]="question.respuesta"
            [disabled]="question.saved"
            placeholder="Escribe tu respuesta aqu√≠..." 
            required>
        </div>

        <!-- Desarrollo -->
        <div *ngIf="question.type === 'desarrollo'" class="q-options desarrollo-answer">
          <label [for]="'q' + question.id">Tu respuesta:</label>
          <textarea 
            [id]="'q' + question.id" 
            [name]="'q' + question.id" 
            [(ngModel)]="question.respuesta"
            [disabled]="question.saved"
            placeholder="Desarrolla tu respuesta aqu√≠..." 
            rows="4"
            required></textarea>
        </div>

        <!-- File Upload (Opcional - mantiene compatibilidad) -->
        <div *ngIf="question.type === 'file'" class="q-options file-upload">
          <button type="button" class="btn primary small" [disabled]="question.saved">Adjuntar archivo</button>
          <span class="file-name">{{ question.respuesta || 'Ning√∫n archivo seleccionado.' }}</span>
          <div class="file-actions" [style.display]="question.respuesta ? 'block' : 'none'">
            <button type="button" class="btn primary small" (click)="saveAnswer(question)">Guardar cambios</button>
            <button type="button" class="btn ghost small" (click)="question.respuesta = ''">Cancelar</button>
          </div>
        </div>

        <div class="q-actions">
          <button *ngIf="!question.saved && question.respuesta && question.respuesta.toString().trim() !== ''" 
                  type="button" 
                  class="btn ghost small" 
                  (click)="saveAnswer(question)">
            Guardar respuesta
          </button> 
          <button *ngIf="question.saved" 
                  type="button" 
                  class="btn ghost small" 
                  (click)="editAnswer(question)">
            Editar respuesta
          </button>
          <span *ngIf="question.saved" class="saved-badge">‚úÖ Guardada</span>
        </div>
      </section>

      <div class="finish-row">
        <button type="submit" class="btn primary finish-btn">Finalizar Evaluaci√≥n</button>
        <p class="finish-note" *ngIf="questions">
          {{ getQuestionsCount() }} pregunta{{ getQuestionsCount() !== 1 ? 's' : '' }} en total ‚Ä¢ 
          {{ getSavedQuestionsCount() }} guardada{{ getSavedQuestionsCount() !== 1 ? 's' : '' }}
        </p>
      </div>
    </form>
  </div>

  <!-- Modal: Advertencia de preguntas sin responder -->
  <div *ngIf="showIncompleteWarning" class="modal-overlay">
    <div class="modal-card modal-error">
      <div class="modal-icon">‚ö†Ô∏è</div>
      <h3>¬øFinalizar evaluaci√≥n?</h3>
      <p>
        <span *ngIf="hasUnsavedAnswers()">Tienes respuestas sin guardar. </span>
        <span *ngIf="hasUnansweredRequiredQuestions()">Hay preguntas obligatorias sin responder. </span>
        ¬øDesea finalizar la evaluaci√≥n? Las preguntas sin respuesta se calificar√°n con cero puntos.
      </p>
      <div class="modal-actions">
        <button class="btn primary" (click)="confirmSubmission()">S√≠, Finalizar</button>
        <button class="btn ghost" (click)="closeModals()">Seguir Respondiendo</button>
      </div>
    </div>
  </div>

  <!-- Modal: Tiempo agotado -->
  <div *ngIf="showTimeUpModal" class="modal-overlay">
    <div class="modal-card modal-error">
      <div class="modal-icon">üõë</div>
      <h3>Se ha acabado el tiempo</h3>
      <p>La evaluaci√≥n ha sido enviada autom√°ticamente al sistema para su correcci√≥n. No es posible continuar resolviendo.</p>
      <div class="modal-actions">
        <button class="btn primary full-width" (click)="returnToPanel()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal: √âxito -->
  <div *ngIf="showSuccessModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-icon" style="color:#1a7f37; font-size:32px;">‚úÖ</div>
      <h3>¬°Evaluaci√≥n Finalizada con √âxito!</h3>
      <p>Tu evaluaci√≥n ha sido guardada y enviada al docente para su correcci√≥n. Puedes consultar el estado en "Mis evaluaciones".</p>
      <div class="modal-actions">
        <button class="btn primary full-width" (click)="returnToPanel()">Volver a Evaluaciones</button>
      </div>
    </div>
  </div>
</main>