<header class="topbar">
  <div class="brand">
    <img src="assets/images/logo.png" alt="Logo Examia" class="logo">
  </div>
  <button class="icon-btn profile" aria-label="Perfil">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14Z"/>
    </svg>
  </button>
</header>

<section class="hero">
  <img src="assets/images/estudiantes.jpg" alt="Estudiantes en clase">
</section>

<main class="wrap">
  <div class="header-row">
    <a routerLink="/alumno/panel" class="icon-btn back" aria-label="Volver">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M14 7l-5 5 5 5V7z"/>
      </svg>
    </a>
    <h1 class="title">Mis evaluaciones</h1>
  </div>
  <p class="subtitle">Consult√° tus ex√°menes: activos, en curso, entregados y corregidos.</p>

  <!-- Controles de recarga y estado -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <button class="btn ghost" (click)="recargar()" [disabled]="isLoading">
      üîÑ {{ isLoading ? 'Cargando...' : 'Actualizar' }}
    </button>
    <span *ngIf="!isLoading" class="meta">
      {{ filteredEvaluaciones.length }} evaluaci√≥n(es) encontrada(s)
      <span *ngIf="materiaDesdeMaterias" class="chip chip-materia">
        Filtrado por: {{ materiaDesdeMaterias }}
      </span>
    </span>
  </div>

  <!-- Filtros -->
  <section class="filters">
    <div class="search">
      <svg viewBox="0 0 24 24"><path d="M21 20l-4.35-4.35A7.5 7.5 0 1 0 9.5 17a7.46 7.46 0 0 0 4.15-1.26L18 20zM4 9.5A5.5 5.5 0 1 1 9.5 15 5.51 5.51 0 0 1 4 9.5z"/></svg>
      <input 
        [(ngModel)]="searchTerm" 
        (input)="onSearchChange(searchTerm)"
        type="search" 
        placeholder="Buscar por materia o t√≠tulo‚Ä¶">
    </div>
    
    <select [(ngModel)]="estadoFilter" (change)="onEstadoFilterChange(estadoFilter)">
      <option value="todos">Todos los estados</option>
      <option value="activo">Activas</option>
      <option value="pendiente">Entregadas</option>
      <option value="corregido">Corregidas</option>
    </select>
    
    <select [(ngModel)]="materiaFilter" (change)="onMateriaFilterChange(materiaFilter)">
      <option value="todos">Todas las materias</option>
      <option *ngFor="let materia of materiasUnicas" [value]="materia">
        {{ materia }}
      </option>
    </select>
    
    <select [(ngModel)]="selectedSort" (change)="onSortChange(selectedSort)">
      <option value="">Ordenar por</option>
      <option>M√°s pr√≥ximas primero</option>
      <option>M√°s recientes</option>
      <option>Mejor calificaci√≥n</option>
    </select>
  </section>

  <!-- Estados de carga y error -->
  <div *ngIf="isLoading" class="empty">
    <p>üîÑ Cargando tus evaluaciones...</p>
  </div>

  <div *ngIf="error && !isLoading" class="empty">
    <p>‚ùå {{ error }}</p>
    <button class="btn primary" (click)="cargarEvaluaciones()">Reintentar</button>
  </div>

  <!-- Lista de Evaluaciones DIN√ÅMICA -->
  <section *ngIf="!isLoading && !error" class="evals">
    <!-- Estado vac√≠o -->
    <div *ngIf="filteredEvaluaciones.length === 0" class="empty">
      <p>No se encontraron evaluaciones con los filtros aplicados.</p>
      <button class="btn ghost" (click)="estadoFilter = 'todos'; materiaFilter = 'todos'; searchTerm = ''; aplicarFiltros()">
        Limpiar filtros
      </button>
    </div>

    <!-- Evaluaciones DIN√ÅMICAS desde la base de datos -->
    <article *ngFor="let eval of filteredEvaluaciones" class="eval-card">
      <div class="left">
        <div class="icon">
          <span>{{ getIcon(eval.estado) }}</span>
        </div>
        <div class="info">
          <h3>{{ eval.titulo }} <span class="chip chip-materia">{{ eval.materia }}</span></h3>
          <p class="meta">Docente: <strong>{{ eval.docente }}</strong></p>
          <p class="meta">
            <span>{{ getFechaDisplay(eval) }}</span>
            <span *ngIf="eval.estado === 'corregido' && eval.calificacion !== null && eval.calificacion !== undefined">
              ‚Ä¢ Calificaci√≥n: <strong>{{ eval.calificacion }}/10</strong>
            </span>
            <span *ngIf="tieneRetroalimentacion(eval)">
              ‚Ä¢ Retroalimentaci√≥n disponible
            </span>
          </p>
          <span [class]="getBadgeClass(eval.estado)">
            {{ getEstadoDisplay(eval.estado) }}
          </span>
        </div>
      </div>
      <div class="right">
        <!-- Activa -->
        <button *ngIf="eval.estado === 'activo'" 
                class="btn primary" 
                (click)="takeEvaluation(eval)">
          Rendir ahora
        </button>
        <button *ngIf="eval.estado === 'activo'" 
                class="btn ghost" 
                (click)="verInstrucciones(eval.id)">
          Ver instrucciones
        </button>

        <!-- Pendiente (Entregada) -->
        <button *ngIf="eval.estado === 'pendiente'" 
                class="btn ghost" 
                (click)="verEnvio(eval.id)">
          Ver env√≠o
        </button>

        <!-- Corregida -->
        <button *ngIf="eval.estado === 'corregido'" 
                class="btn primary" 
                (click)="verResultado(eval.id)">
          Ver resultado
        </button>
        <button *ngIf="eval.estado === 'corregido' && tieneRetroalimentacion(eval)" 
                class="btn ghost" 
                (click)="verFeedback(eval)">
          Comentarios
        </button>
      </div>
    </article>
  </section>

  <!-- Modal: Evaluaci√≥n ya Finalizada -->
  <div *ngIf="showFinishedModal" class="modal-overlay">
    <div class="modal-card modal-error">
      <div class="modal-icon">‚ö†Ô∏è</div>
      <h3>Evaluaci√≥n ya Finalizada</h3>
      <p>La evaluaci√≥n '{{ selectedEvaluation?.titulo }}' ya ha sido resuelta y finalizada por usted. No es posible un nuevo intento.</p>
      <div class="modal-actions">
        <button class="btn primary full-width" (click)="closeModals()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Descartar Intento -->
  <div *ngIf="showDiscardModal" class="modal-overlay">
    <div class="modal-card modal-error">
      <div class="modal-icon">üóëÔ∏è</div>
      <h3>Descartar Progreso</h3>
      <p>¬øEst√° seguro de que desea descartar su intento en '{{ selectedEvaluation?.titulo }}'? Se perder√°n todos los datos guardados.</p>
      <div class="modal-actions">
        <button class="btn primary" (click)="discardAttempt()">S√≠, Descartar</button>
        <button class="btn ghost" (click)="closeModals()">Cancelar</button>
      </div>
    </div>
  </div>
</main>