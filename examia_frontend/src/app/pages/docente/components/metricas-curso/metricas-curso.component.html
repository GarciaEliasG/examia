<header class="topbar">
  <div class="brand">
    <img src="assets/images/logo.png" alt="Logo Examia" class="logo">
  </div>
  <button class="icon-btn profile" aria-label="Perfil">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14Z"/>
    </svg>
  </button>
</header>

<main class="wrap">
  <div class="header-row">
    <button class="icon-btn back" aria-label="Volver" (click)="volverACursos()">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M14 7l-5 5 5 5V7z"/></svg>
    </button>
    <h1 class="title">M√©tricas del Curso</h1>
  </div>

  <!-- Estado de carga -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando m√©tricas del curso...</p>
  </div>

  <!-- Estado de error -->
  <div *ngIf="error && !loading" class="error-state">
    <h3>‚ö†Ô∏è Error</h3>
    <p>{{ error }}</p>
    <button class="btn primary" (click)="recargar()">Reintentar</button>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="metricas && !loading && !error">
    
    <!-- Informaci√≥n del curso -->
    <div class="curso-info card">
      <h2>{{ metricas.curso.nombre }}</h2>
      <p class="curso-desc">{{ metricas.curso.descripcion }}</p>
    </div>

    <!-- M√©tricas generales -->
    <section class="metricas-generales">
      <h2>Resumen General</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üìö</div>
          <div class="stat-content">
            <h3>{{ metricas.metricas_generales.total_examenes }}</h3>
            <p>Ex√°menes Totales</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-content">
            <h3>{{ metricas.metricas_generales.total_alumnos }}</h3>
            <p>Alumnos Inscritos</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üìù</div>
          <div class="stat-content">
            <h3>{{ metricas.metricas_generales.total_evaluaciones_corregidas }}</h3>
            <p>Evaluaciones Corregidas</p>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <h3 [ngClass]="getColorCalificacion(metricas.metricas_generales.nota_promedio_curso)">
              {{ metricas.metricas_generales.nota_promedio_curso }}
            </h3>
            <p>Nota Promedio</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Filtros -->
    <section class="card filtros">
      <h3>Filtrar por Examen</h3>
      <div class="filtros-grid">
        <div class="filtro-group">
          <label for="filtroExamen">Examen:</label>
          <select id="filtroExamen" [(ngModel)]="filtroExamen">
            <option value="all">Todos los ex√°menes</option>
            <option *ngFor="let examen of metricas.metricas_examenes" [value]="examen.examen_id">
              {{ examen.titulo }}
            </option>
          </select>
        </div>
        <button class="btn secondary" (click)="navegarAAlumnos()">
          üë• Ver Alumnos
        </button>
      </div>
    </section>

    <!-- M√©tricas por examen -->
    <section class="metricas-examenes">
      <h2>M√©tricas por Examen</h2>
      
      <div *ngIf="getMetricasFiltradas().length === 0" class="empty-state">
        <p>No hay m√©tricas disponibles para los filtros seleccionados.</p>
      </div>

      <div *ngFor="let examen of getMetricasFiltradas()" class="card examen-metricas">
        <div class="examen-header">
          <h3>{{ examen.titulo }}</h3>
          <div class="examen-stats">
            <span class="nota-promedio" [ngClass]="getColorCalificacion(examen.nota_promedio)">
              {{ examen.nota_promedio }} pts
            </span>
            <span class="participacion">
              {{ examen.porcentaje_participacion }}% participaci√≥n
            </span>
          </div>
        </div>

        <!-- Distribuci√≥n de calificaciones -->
        <div class="distribucion-section">
          <h4>Distribuci√≥n de Calificaciones</h4>
          <div class="distribucion-grid">
            <div class="distribucion-item excelente">
              <span class="distribucion-label">Excelente</span>
              <span class="distribucion-value">{{ examen.distribucion_calificaciones.excelente }}</span>
              <span class="distribucion-porcentaje">
                {{ examen.distribucion_calificaciones.porcentaje_excelente }}%
              </span>
            </div>
            <div class="distribucion-item bueno">
              <span class="distribucion-label">Bueno</span>
              <span class="distribucion-value">{{ examen.distribucion_calificaciones.bueno }}</span>
              <span class="distribucion-porcentaje">
                {{ examen.distribucion_calificaciones.porcentaje_bueno }}%
              </span>
            </div>
            <div class="distribucion-item regular">
              <span class="distribucion-label">Regular</span>
              <span class="distribucion-value">{{ examen.distribucion_calificaciones.regular }}</span>
              <span class="distribucion-porcentaje">
                {{ examen.distribucion_calificaciones.porcentaje_regular }}%
              </span>
            </div>
            <div class="distribucion-item insuficiente">
              <span class="distribucion-label">Insuficiente</span>
              <span class="distribucion-value">{{ examen.distribucion_calificaciones.insuficiente }}</span>
              <span class="distribucion-porcentaje">
                {{ examen.distribucion_calificaciones.porcentaje_insuficiente }}%
              </span>
            </div>
          </div>
        </div>

        <!-- Preguntas problem√°ticas -->
        <div *ngIf="examen.preguntas_problematicas.length > 0" class="preguntas-problematicas">
          <h4>Preguntas con Dificultad</h4>
          <div class="preguntas-list">
            <div *ngFor="let pregunta of examen.preguntas_problematicas" class="pregunta-item">
              <div class="pregunta-header">
                <h5>{{ pregunta.enunciado }}</h5>
                <span class="pregunta-stats" [ngClass]="getColorCalificacion(pregunta.porcentaje_promedio)">
                  {{ pregunta.porcentaje_promedio }}% promedio
                </span>
              </div>
              <p class="pregunta-detalle">
                <strong>Tipo:</strong> {{ pregunta.tipo }} | 
                <strong>Puntaje:</strong> {{ pregunta.puntaje_promedio }}/{{ pregunta.puntaje_maximo }} | 
                <strong>Respuestas:</strong> {{ pregunta.total_respuestas }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>