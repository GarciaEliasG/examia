<!-- pages/docente/components/crear-evaluacion/crear-evaluacion.component.html -->
<header class="topbar">
  <div class="brand">
    <img src="assets/images/logo.png" alt="Logo Examia" class="logo">
  </div>
  <button class="icon-btn profile" aria-label="Perfil">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14Z"/>
    </svg>
  </button>
</header>

<main class="wrap">
  <!-- Header con bot√≥n volver y t√≠tulo -->
  <div class="header-row">
    <a routerLink="/docente/evaluaciones" class="icon-btn back" aria-label="Volver a evaluaciones">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M14 7l-5 5 5 5V7z"/>
      </svg>
    </a>
    <h1 class="title">Crear Evaluaci√≥n</h1>
  </div>

  <!-- Informaci√≥n de la evaluaci√≥n -->
  <section class="form-card">
    <h2 class="section-title">Informaci√≥n General</h2>
    
    <div class="field-grid">
      <div class="field">
        <label for="titulo">T√≠tulo de la evaluaci√≥n *</label>
        <input 
          type="text" 
          id="titulo" 
          placeholder="Ej: Evaluaci√≥n Unidad 1 - Redes" 
          [(ngModel)]="evaluacion.titulo"
          required>
      </div>
      
      <div class="field">
        <label for="curso">Curso *</label>
        <select 
          id="curso" 
          [(ngModel)]="evaluacion.curso_id" 
          required
          [disabled]="isCargandoCursos">
          <option value="">Seleccionar curso</option>
          <option *ngFor="let curso of cursos" [value]="curso.id">
            {{ curso.nombre }} ({{ curso.codigo }})
          </option>
        </select>
        <div *ngIf="isCargandoCursos" class="loading-small">
          Cargando cursos...
        </div>
      </div>
    </div>

    <div class="field">
      <label for="descripcion">Descripci√≥n / Instrucciones</label>
      <textarea 
        id="descripcion" 
        rows="3" 
        placeholder="Detall√° las instrucciones, pautas de entrega, materiales permitidos..."
        [(ngModel)]="evaluacion.descripcion"></textarea>
    </div>

    <div class="field-grid">
      <div class="field">
        <label for="fecha_limite">Fecha L√≠mite</label>
        <input 
          type="datetime-local" 
          id="fecha_limite" 
          [(ngModel)]="evaluacion.fecha_limite">
      </div>
      
      <div class="field">
        <label for="duracion">Duraci√≥n (minutos)</label>
        <input 
          type="number" 
          id="duracion" 
          [(ngModel)]="evaluacion.duracion_minutos" 
          min="1"
          max="480">
      </div>
    </div>

    <div class="field-grid">
      <div class="field">
        <label for="intentos">Intentos Permitidos</label>
        <input 
          type="number" 
          id="intentos" 
          [(ngModel)]="evaluacion.intentos_permitidos" 
          min="1" 
          max="10">
      </div>
      
      <div class="field">
        <label>Puntaje Total</label>
        <div class="puntaje-total">
          <span class="puntaje-valor">{{ calcularPuntajeTotal() }}</span>
          <span class="puntaje-label">puntos</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Preguntas de la evaluaci√≥n -->
  <section class="form-card">
    <div class="card-header">
      <h2 class="section-title">Preguntas</h2>
      <div class="preguntas-count">
        <span class="badge">{{ evaluacion.preguntas.length }}</span>
        <span class="puntaje-total-badge">{{ calcularPuntajeTotal() }} pts</span>
      </div>
    </div>
    
    <div class="preguntas-list">
      
      <!-- Mensaje si no hay preguntas -->
      <div *ngIf="evaluacion.preguntas.length === 0" class="empty-state-preguntas">
        <div class="empty-icon">‚ùì</div>
        <h3>No hay preguntas agregadas</h3>
        <p>Agreg√° preguntas desde el banco o cre√° una nueva.</p>
      </div>

      <!-- Lista de preguntas -->
      <div *ngFor="let pregunta of evaluacion.preguntas; let i = index" 
           class="pregunta-item"
           [class.pregunta-activa]="true">
        
        <div class="pregunta-header">
          <div class="pregunta-info">
            <span class="pregunta-numero">Pregunta {{ i + 1 }}</span>
            <span class="pregunta-tipo">{{ getTipoPreguntaTexto(pregunta.tipo) }}</span>
            <span class="pregunta-puntaje">{{ pregunta.puntaje }} pts</span>
          </div>
          
          <div class="pregunta-actions">
            <button 
              type="button" 
              class="btn-icon" 
              (click)="moverPreguntaArriba(i)"
              [disabled]="!puedeMoverArriba(i)"
              title="Mover arriba">
              <svg viewBox="0 0 24 24" width="16" height="16">
                <path d="M7 14l5-5 5 5z" fill="currentColor"/>
              </svg>
            </button>
            
            <button 
              type="button" 
              class="btn-icon" 
              (click)="moverPreguntaAbajo(i)"
              [disabled]="!puedeMoverAbajo(i)"
              title="Mover abajo">
              <svg viewBox="0 0 24 24" width="16" height="16">
                <path d="M7 10l5 5 5-5z" fill="currentColor"/>
              </svg>
            </button>
            
            <button 
              type="button" 
              class="btn-icon danger" 
              (click)="removerPregunta(i)"
              title="Eliminar pregunta">
              <svg viewBox="0 0 24 24" width="16" height="16">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="pregunta-content">
          <p class="pregunta-enunciado">{{ pregunta.enunciado }}</p>
          
          <!-- Opciones para preguntas de opci√≥n m√∫ltiple -->
          <div *ngIf="pregunta.tipo === 'multiple_choice'" class="opciones-list">
            <div *ngFor="let opcion of pregunta.opciones; let j = index" class="opcion-item">
              <span class="opcion-indice">{{ j + 1 }}.</span>
              <span class="opcion-texto">{{ opcion }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones para agregar preguntas -->
    <div class="preguntas-actions">
      <button type="button" class="btn primary" (click)="abrirPreguntasModal()">
        <svg viewBox="0 0 24 24" width="18" height="18" style="margin-right: 8px;">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/>
        </svg>
        Agregar Preguntas Existentes
      </button>
      
      <!-- BOT√ìN ACTUALIZADO: Ahora abre el nuevo componente crear-pregunta -->
      <button type="button" class="btn ghost" (click)="abrirCrearPreguntaModal()">
        <svg viewBox="0 0 24 24" width="18" height="18" style="margin-right: 8px;">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/>
        </svg>
        Crear Nueva Pregunta
      </button>
    </div>
  </section>

  <!-- Acciones principales -->
  <footer class="actions-footer">
    <button type="button" class="btn ghost large" (click)="cancelar()">
      Cancelar
    </button>
    <button 
      type="button" 
      class="btn primary large" 
      (click)="guardarEvaluacion()" 
      [disabled]="isLoading">
      
      <span *ngIf="!isLoading">
        <svg viewBox="0 0 24 24" width="18" height="18" style="margin-right: 8px;">
          <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" fill="currentColor"/>
        </svg>
        Guardar Evaluaci√≥n
      </span>
      
      <span *ngIf="isLoading">
        <div class="spinner-small"></div>
        Guardando...
      </span>
    </button>
  </footer>
</main>

<!-- Modal de Preguntas Existentes (SIN CAMBIOS) -->
<div *ngIf="showPreguntasModal" class="modal-overlay">
  <div class="modal-backdrop" (click)="cerrarPreguntasModal()"></div>
  <div class="modal-card large">
    <div class="modal-header">
      <h3>Seleccionar Preguntas</h3>
      <button class="modal-close" (click)="cerrarPreguntasModal()" aria-label="Cerrar">
        <svg viewBox="0 0 24 24" width="20" height="20">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
        </svg>
      </button>
    </div>
    
    <div class="modal-content">
      <div class="preguntas-grid">
        
        <!-- Mensaje si no hay preguntas disponibles -->
        <div *ngIf="preguntasDisponibles.length === 0" class="empty-state-modal">
          <div class="empty-icon">üìù</div>
          <h4>No hay preguntas disponibles</h4>
          <p>Cre√° preguntas primero para poder agregarlas a evaluaciones.</p>
        </div>

        <!-- Lista de preguntas disponibles -->
        <div *ngFor="let pregunta of preguntasDisponibles" 
             class="pregunta-selectable"
             [class.pregunta-agregada]="esPreguntaAgregada(pregunta.id)">
          
          <div class="pregunta-selectable-header">
            <h4 class="pregunta-titulo">{{ pregunta.enunciado }}</h4>
            <div class="pregunta-meta">
              <span class="pregunta-tipo-badge">{{ getTipoPreguntaTexto(pregunta.tipo) }}</span>
              <span class="pregunta-puntaje-badge">{{ pregunta.puntaje }} pts</span>
            </div>
          </div>
          
          <p class="pregunta-desc">
            {{ pregunta.tipo === 'multiple_choice' ? 'Opci√≥n m√∫ltiple' : 'Respuesta abierta' }}
          </p>

          <button 
            class="btn primary sm" 
            (click)="agregarPregunta(pregunta)"
            [disabled]="estaPreguntaAgregada(pregunta.id)">
            
            {{ getTextoBotonPregunta(pregunta.id) }}
          </button>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn ghost" (click)="cerrarPreguntasModal()">
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- NUEVO: Modal de Crear Pregunta -->
<app-crear-pregunta 
  *ngIf="showCrearPreguntaModal"
  (preguntaCreada)="onPreguntaCreada($event)"
  (cancelar)="cerrarCrearPreguntaModal()">
</app-crear-pregunta>

<!-- NUEVO: Modal de √âxito -->
<div *ngIf="showSuccessModal" class="modal-overlay">
  <div class="modal-backdrop" (click)="cerrarModalExito()"></div>
  <div class="modal-card success-modal">
    <div class="modal-header success-header">
      <div class="success-icon">
        <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor">
          <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
        </svg>
      </div>
      <h3>¬°Evaluaci√≥n Creada!</h3>
    </div>
    
    <div class="modal-content success-content">
      <p>La evaluaci√≥n <strong>"{{ evaluacion.titulo }}"</strong> se ha creado exitosamente.</p>
      <div class="success-details">
        <div class="detail-item">
          <span class="detail-label">Curso:</span>
          <span class="detail-value">{{ obtenerNombreCurso() }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Preguntas:</span>
          <span class="detail-value">{{ evaluacion.preguntas.length }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Puntaje total:</span>
          <span class="detail-value">{{ calcularPuntajeTotal() }} puntos</span>
        </div>
      </div>
    </div>

    <div class="modal-actions success-actions">
      <button 
        type="button" 
        class="btn primary large" 
        (click)="irAlMenuPrincipal()">
        <svg viewBox="0 0 24 24" width="18" height="18" style="margin-right: 8px;">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="currentColor"/>
        </svg>
        Continuar al Men√∫ Principal
      </button>
      
      <button 
        type="button" 
        class="btn ghost" 
        (click)="crearOtraEvaluacion()">
        Crear Otra Evaluaci√≥n
      </button>
    </div>
  </div>
</div>